@page "/signin"
@using System.Net;
@using Client.Components.Public.Warp
@using Client.Providers
@using Client.Services
@using System.Net.Http.Json;
@using global::Shared.Models;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.IdentityModel.Tokens;
@using System.IdentityModel.Tokens.Jwt;
@using System.Security.Claims;
@using System.Text;
@using Blazored.LocalStorage


<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Warp</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

</head>
<Client.Components.Public.Shared.NavB />

<PageTitle>Warp</PageTitle>

<body class="d-flex flex-column h-100">


    <!--The div element for the map -->
    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->



    <main class="flex-shrink-0">
        <!-- Navigation-->
        <!-- Header-->
        <!-- Features section-->
        <!-- Testimonial section-->
        <!-- Blog preview section-->
        <div id="map"></div>


        <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
        <section class="py-5">
            <div class="container px-5 my-5">

                <div class="row gx-5">

                    <div class="col">
                        @if (_signinSuccessful == false)
                        {

                            <EditForm Model="_userToSignin" OnValidSubmit="SigninUser">
                                <DataAnnotationsValidator />
                                <div class="form-group my-3">
                                    <label for="email">Email address</label>
                                    <InputText @bind-Value="_userToSignin.EmailAddress" id="email" class="form-control" />
                                    <ValidationMessage For="@(() => _userToSignin.EmailAddress)" />
                                </div>


                                <div class="form-group my-3">
                                    <label for="password">Password</label>
                                    <InputText @bind-Value="_userToSignin.Password" id="password" type="password" class="form-control" />
                                    <ValidationMessage For="@(() => _userToSignin.Password)" />
                                </div>



                                <!-- partial
                                <div class="form-group my-3">
                                <label for="dob">Date Of Birth</label>
                                <InputDate @bind-Value="_userToCreate1.Dob" id="dob" class="form-control" />
                                <ValidationMessage For="@(() => _userToCreate1.Dob)" />
                                </div>-->

                            <ValidationSummary />

                                <button class="btn btn-success shadow d-block mt-5 md-f-size-1-5" type="submit">
                                    <i class="far fa-save"></i> Signin
                                </button>

                            </EditForm>
                            @if (_signinFailed == true)
                            {
                                <p class="my-3 text-danger"> Sign In Failed, Please check username/password</p>
                            }


                        }
                        else
                        {

                            <h4>Signin Sucessfull click to return</h4>

                            <a href="/" class="btn btn-primary shadow mt-5 md-f-size-1-5">
                                <i class="fas fa-arrow-left"></i> Return
                            </a>
                        }
                    </div>

                </div>
            </div>
            <!-- Call to action-->

       
        </section>
    </main>
 
    <!-- Bootstrap core JS-->
    <!-- Core theme JS-->

</body>
   <!-- Footer-->
    <footer class="bg-dark py-4 mt-auto">
        <div class="container px-5">
            <div class="row align-items-center justify-content-between flex-column flex-sm-row">
                <div class="col-auto"><div class="small m-0 text-white">Copyright &copy; Your Website 2021</div></div>
                <div class="col-auto">
                    <a class="link-light small" href="#!">Privacy</a>
                    <span class="text-white mx-1">&middot;</span>
                    <a class="link-light small" href="#!">Terms</a>
                    <span class="text-white mx-1">&middot;</span>
                    <a class="link-light small" href="#!">Contact</a>
                </div>
            </div>
        </div>
    </footer>


@code
{
    [Inject] InMemoryDatabaseCache InMemoryDatabaseCache { get; set; }
    [Inject] IJSRuntime JSRuntime { get; set; }
    [Inject] HttpClient HttpClient { get; set; }
    [Inject] ILocalStorageService LocalStorageService { get; set; }
    [Inject] AuthenticationStateProvider authenticationStateProvider { get; set; }
    [Inject] AppAuthenticationStateProvider appAuthenticationStateProvider { get; set; }
    [Inject] public NavigationManager NavigationManager { get; set; }

    //protected async override Task OnAfterRenderAsync(bool firstRender)
    //{
    //    if (firstRender)
    //    {
    //        if (InMemoryDatabaseCache.Cars == null)
    //        {
    //            await InMemoryDatabaseCache.GetCarsFromDatabaseAndCache();
    //            StateHasChanged();
    //        }
    //    }
    //}



    private User _userToSignin = new User();
    private bool _attemptingToSignin = false;
    private bool _signinSuccessful = false;
    private bool _signinFailed = false;

    private async Task SigninUser()
    {
        _attemptingToSignin = false;


        HttpResponseMessage response = await HttpClient.PostAsJsonAsync<User>(APIEndpoints.s_signIn, _userToSignin);

        if (response.IsSuccessStatusCode)
        {
            string jsonWebToken = await response.Content.ReadAsStringAsync();

            await LocalStorageService.SetItemAsync("bearerToken", jsonWebToken);

            await ((AppAuthenticationStateProvider)authenticationStateProvider).SignIn();

            HttpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("bearer", jsonWebToken);

            _signinSuccessful = true;

             StateHasChanged();
             NavigationManager.NavigateTo("/");
            
        }
        else
        {
            _attemptingToSignin = true;

        }


    }

	}
}